<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voronoi Bloom — Shadow's Garden</title>
<meta name="description" content="Interactive Voronoi diagrams that pulse and bloom. Click to seed new sites.">
<link rel="stylesheet" href="../style.css">
<script src="../nav.js" defer></script>
<style>
  body { margin: 0; overflow: hidden; background: #0a0a12; }
  canvas { display: block; }
  .controls {
    position: fixed;
    bottom: 20px;
    left: 20px;
    display: flex;
    gap: 10px;
    z-index: 10;
  }
  button {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: #fff;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    font-size: 13px;
    transition: all 0.2s;
  }
  button:hover { background: rgba(255,255,255,0.2); }
  .info {
    position: fixed;
    top: 20px;
    left: 20px;
    color: rgba(255,255,255,0.4);
    font-size: 13px;
    font-family: monospace;
  }
</style>
</head>
<body data-page-type="app">
  <canvas id="canvas"></canvas>
  <div class="info">Click to seed new sites • Space to pause • R to reset</div>
  <div class="controls">
    <button id="preset1">Jewel Tones</button>
    <button id="preset2">Sunset</button>
    <button id="preset3">Monochrome</button>
    <button id="preset4">Chaos</button>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    let width, height;
    let sites = [];
    let palette = 'jewel';
    let paused = false;
    let time = 0;
    
    const SITE_COUNT = 50;
    
    const palettes = {
      jewel: ['#00f5d4', '#00bbf9', '#9b5de5', '#f15bb5', '#fee440'],
      sunset: ['#ff6b6b', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd'],
      mono: ['#ffffff', '#cccccc', '#999999', '#666666', '#333333'],
      chaos: ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#00ffff', '#ff00ff']
    };
    
    function resize() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
    }
    
    function initSites() {
      sites = [];
      for (let i = 0; i < SITE_COUNT; i++) {
        sites.push({
          x: Math.random() * width,
          y: Math.random() * height,
          vx: (Math.random() - 0.5) * 0.5,
          vy: (Math.random() - 0.5) * 0.5,
          color: palettes[palette][Math.floor(Math.random() * palettes[palette].length)],
          phase: Math.random() * Math.PI * 2
        });
      }
    }
    
    function distToClosestSite(x, y) {
      let minDist = Infinity;
      sites.forEach(site => {
        const d = Math.hypot(x - site.x, y - site.y);
        if (d < minDist) minDist = d;
      });
      return minDist;
    }
    
    function update() {
      if (paused) return;
      time += 0.02;
      
      sites.forEach(site => {
        site.x += site.vx;
        site.y += site.vy;
        
        // Bounce off edges
        if (site.x < 0 || site.x > width) site.vx *= -1;
        if (site.y < 0 || site.y > height) site.vy *= -1;
        
        // Keep in bounds
        site.x = Math.max(0, Math.min(width, site.x));
        site.y = Math.max(0, Math.min(height, site.y));
      });
    }
    
    function draw() {
      // Draw cells
      const imageData = ctx.createImageData(width, height);
      const data = imageData.data;
      
      // Skip pixels for performance
      const step = 2;
      for (let y = 0; y < height; y += step) {
        for (let x = 0; x < width; x += step) {
          let minDist = Infinity;
          let closestSite = sites[0];
          
          sites.forEach(site => {
            const d = Math.hypot(x - site.x, y - site.y);
            if (d < minDist) {
              minDist = d;
              closestSite = site;
            }
          });
          
          // Pulsing effect based on distance
          const pulse = Math.sin(time * 2 + closestSite.phase) * 0.3 + 0.7;
          const bloom = Math.max(0, 1 - minDist / 150) * pulse;
          
          // Parse color
          const hex = closestSite.color;
          const r = parseInt(hex.slice(1, 3), 16);
          const g = parseInt(hex.slice(3, 5), 16);
          const b = parseInt(hex.slice(5, 7), 16);
          
          // Draw the pixel block
          for (let dy = 0; dy < step && y + dy < height; dy++) {
            for (let dx = 0; dx < step && x + dx < width; dx++) {
              const idx = ((y + dy) * width + (x + dx)) * 4;
              data[idx] = r * bloom + 10 * (1 - bloom);
              data[idx + 1] = g * bloom + 10 * (1 - bloom);
              data[idx + 2] = b * bloom + 18 * (1 - bloom);
              data[idx + 3] = 255;
            }
          }
        }
      }
      
      ctx.putImageData(imageData, 0, 0);
      
      // Draw site centers with glow
      sites.forEach(site => {
        const pulse = Math.sin(time * 3 + site.phase) * 0.5 + 0.5;
        
        // Outer glow
        const gradient = ctx.createRadialGradient(site.x, site.y, 0, site.x, site.y, 30);
        gradient.addColorStop(0, site.color);
        gradient.addColorStop(1, 'transparent');
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(site.x, site.y, 30, 0, Math.PI * 2);
        ctx.fill();
        
        // Core
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.arc(site.x, site.y, 3 + pulse * 2, 0, Math.PI * 2);
        ctx.fill();
      });
    }
    
    function animate() {
      update();
      draw();
      requestAnimationFrame(animate);
    }
    
    // Events
    canvas.addEventListener('click', (e) => {
      sites.push({
        x: e.clientX,
        y: e.clientY,
        vx: (Math.random() - 0.5) * 0.5,
        vy: (Math.random() - 0.5) * 0.5,
        color: palettes[palette][Math.floor(Math.random() * palettes[palette].length)],
        phase: Math.random() * Math.PI * 2
      });
    });
    
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        paused = !paused;
        e.preventDefault();
      }
      if (e.code === 'KeyR') {
        initSites();
      }
    });
    
    // Presets
    document.getElementById('preset1').onclick = () => { palette = 'jewel'; initSites(); };
    document.getElementById('preset2').onclick = () => { palette = 'sunset'; initSites(); };
    document.getElementById('preset3').onclick = () => { palette = 'mono'; initSites(); };
    document.getElementById('preset4').onclick = () => { palette = 'chaos'; initSites(); };
    
    window.addEventListener('resize', resize);
    resize();
    initSites();
    animate();
  </script>
</body>
</html>
