<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fluid Simulation — Shadow's Garden</title>
<meta name="description" content="Real-time Navier-Stokes fluid simulation with mouse interaction.">
<link rel="stylesheet" href="../style.css">
<script src="../nav.js" defer></script>
<style>
  body { margin: 0; overflow: hidden; background: #0a0a0f; }
  canvas { display: block; cursor: crosshair; }
  .controls {
    position: fixed;
    bottom: 20px;
    left: 20px;
    display: flex;
    gap: 10px;
    z-index: 10;
    flex-wrap: wrap;
    max-width: 400px;
  }
  button {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: #fff;
    padding: 8px 14px;
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    font-size: 12px;
    transition: all 0.2s;
  }
  button:hover { background: rgba(255,255,255,0.25); }
  button.active { background: rgba(100,200,255,0.3); border-color: rgba(100,200,255,0.5); }
  .info {
    position: fixed;
    top: 20px;
    left: 20px;
    color: rgba(255,255,255,0.4);
    font-size: 12px;
    font-family: monospace;
  }
  .slider-container {
    display: flex;
    align-items: center;
    gap: 8px;
    color: rgba(255,255,255,0.5);
    font-size: 11px;
  }
  input[type="range"] {
    width: 80px;
    accent-color: #6cf;
  }
</style>
</head>
<body data-page-type="app">
  <canvas id="canvas"></canvas>
  <div class="info">Click and drag to add fluid • Scroll to change radius</div>
  <div class="controls">
    <button id="btn-smoke">Smoke</button>
    <button id="btn-ink">Ink</button>
    <button id="btn-fire">Fire</button>
    <button id="btn-rainbow">Rainbow</button>
    <button id="btn-clear">Clear</button>
    <div class="slider-container">
      <span>Radius</span>
      <input type="range" id="radius" min="10" max="100" value="40">
    </div>
    <div class="slider-container">
      <span>Diffusion</span>
      <input type="range" id="diffusion" min="0" max="100" value="10">
    </div>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    let width, height;
    let N = 128;
    let size = (N + 2) * (N + 2);
    let u = new Float32Array(size); // velocity x
    let v = new Float32Array(size); // velocity y
    let u_prev = new Float32Array(size);
    let v_prev = new Float32Array(size);
    let dens = new Float32Array(size); // density
    let dens_prev = new Float32Array(size);
    
    let mouseX = 0, mouseY = 0, mouseDown = false;
    let brushRadius = 40;
    let diffusion = 0.0001;
    let colorMode = 'smoke';
    let hue = 0;
    
    function IX(x, y) {
      return x + (N + 2) * y;
    }
    
    function addSource(x, s, dt) {
      for (let i = 0; i < size; i++) x[i] += dt * s[i];
    }
    
    function setBnd(b, x) {
      for (let i = 1; i <= N; i++) {
        x[IX(0, i)] = b === 1 ? -x[IX(1, i)] : x[IX(1, i)];
        x[IX(N + 1, i)] = b === 1 ? -x[IX(N, i)] : x[IX(N, i)];
        x[IX(i, 0)] = b === 2 ? -x[IX(i, 1)] : x[IX(i, 1)];
        x[IX(i, N + 1)] = b === 2 ? -x[IX(i, N)] : x[IX(i, N)];
      }
      x[IX(0, 0)] = 0.5 * (x[IX(1, 0)] + x[IX(0, 1)]);
      x[IX(0, N + 1)] = 0.5 * (x[IX(1, N + 1)] + x[IX(0, N)]);
      x[IX(N + 1, 0)] = 0.5 * (x[IX(N, 0)] + x[IX(N + 1, 1)]);
      x[IX(N + 1, N + 1)] = 0.5 * (x[IX(N, N + 1)] + x[IX(N + 1, N)]);
    }
    
    function linSolve(b, x, x0, a, c) {
      const cRecip = 1.0 / c;
      for (let k = 0; k < 4; k++) {
        for (let j = 1; j <= N; j++) {
          for (let i = 1; i <= N; i++) {
            x[IX(i, j)] = (x0[IX(i, j)] + a * (x[IX(i - 1, j)] + x[IX(i + 1, j)] + x[IX(i, j - 1)] + x[IX(i, j + 1)])) * cRecip;
          }
        }
        setBnd(b, x);
      }
    }
    
    function diffuse(b, x, x0, diff, dt) {
      const a = dt * diff * N * N;
      linSolve(b, x, x0, a, 1 + 4 * a);
    }
    
    function project(u, v, p, div) {
      for (let j = 1; j <= N; j++) {
        for (let i = 1; i <= N; i++) {
          div[IX(i, j)] = -0.5 * (u[IX(i + 1, j)] - u[IX(i - 1, j)] + v[IX(i, j + 1)] - v[IX(i, j - 1)]) / N;
          p[IX(i, j)] = 0;
        }
      }
      setBnd(0, div);
      setBnd(0, p);
      linSolve(0, p, div, 1, 4);
      
      for (let j = 1; j <= N; j++) {
        for (let i = 1; i <= N; i++) {
          u[IX(i, j)] -= 0.5 * (p[IX(i + 1, j)] - p[IX(i - 1, j)]) * N;
          v[IX(i, j)] -= 0.5 * (p[IX(i, j + 1)] - p[IX(i, j - 1)]) * N;
        }
      }
      setBnd(1, u);
      setBnd(2, v);
    }
    
    function advect(b, d, d0, u, v, dt) {
      const dt0 = dt * N;
      for (let j = 1; j <= N; j++) {
        for (let i = 1; i <= N; i++) {
          let x = i - dt0 * u[IX(i, j)];
          let y = j - dt0 * v[IX(i, j)];
          if (x < 0.5) x = 0.5;
          if (x > N + 0.5) x = N + 0.5;
          if (y < 0.5) y = 0.5;
          if (y > N + 0.5) y = N + 0.5;
          const i0 = Math.floor(x);
          const i1 = i0 + 1;
          const j0 = Math.floor(y);
          const j1 = j0 + 1;
          const s1 = x - i0;
          const s0 = 1 - s1;
          const t1 = y - j0;
          const t0 = 1 - t1;
          d[IX(i, j)] = s0 * (t0 * d0[IX(i0, j0)] + t1 * d0[IX(i0, j1)]) +
                        s1 * (t0 * d0[IX(i1, j0)] + t1 * d0[IX(i1, j1)]);
        }
      }
      setBnd(b, d);
    }
    
    function velStep(u, v, u0, v0, visc, dt) {
      addSource(u, u0, dt);
      addSource(v, v0, dt);
      [u0, u] = [u, u0];
      diffuse(1, u, u0, visc, dt);
      [v0, v] = [v, v0];
      diffuse(2, v, v0, visc, dt);
      project(u, v, u0, v0);
      [u0, u] = [u, u0];
      [v0, v] = [v, v0];
      advect(1, u, u0, u0, v0, dt);
      advect(2, v, v0, u0, v0, dt);
      project(u, v, u0, v0);
    }
    
    function densStep(x, x0, u, v, diff, dt) {
      addSource(x, x0, dt);
      [x0, x] = [x, x0];
      diffuse(0, x, x0, diff, dt);
      [x0, x] = [x, x0];
      advect(0, x, x0, u, v, dt);
    }
    
    function resize() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
    }
    
    function getColor(d, i, j) {
      const c = d[IX(i, j)];
      if (c < 0.01) return 'rgba(0,0,0,0)';
      
      switch (colorMode) {
        case 'ink':
          return `rgba(20, 30, 40, ${Math.min(1, c * 0.5)})`;
        case 'fire':
          const r = Math.min(255, c * 400);
          const g = Math.min(255, c * 150);
          return `rgba(${r}, ${g}, 0, ${Math.min(0.9, c)})`;
        case 'rainbow':
          const h = (hue + c * 100) % 360;
          return `hsla(${h}, 80%, 60%, ${Math.min(0.9, c)})`;
        default: // smoke
          const val = Math.min(255, c * 200);
          return `rgba(${val}, ${val}, ${val + 20}, ${Math.min(0.8, c)})`;
      }
    }
    
    function draw() {
      const cellW = width / N;
      const cellH = height / N;
      
      for (let j = 1; j <= N; j++) {
        for (let i = 1; i <= N; i++) {
          if (dens[IX(i, j)] > 0.01) {
            ctx.fillStyle = getColor(dens, i, j);
            ctx.fillRect((i - 1) * cellW, (j - 1) * cellH, cellW + 1, cellH + 1);
          }
        }
      }
    }
    
    function step(dt) {
      const visc = 0.00001;
      
      // Add velocity from mouse
      if (mouseDown) {
        const gridX = Math.floor((mouseX / width) * N) + 1;
        const gridY = Math.floor((mouseY / height) * N) + 1;
        const radius = Math.floor((brushRadius / width) * N);
        
        for (let dj = -radius; dj <= radius; dj++) {
          for (let di = -radius; di <= radius; di++) {
            if (di * di + dj * dj <= radius * radius) {
              const i = Math.max(1, Math.min(N, gridX + di));
              const j = Math.max(1, Math.min(N, gridY + dj));
              const idx = IX(i, j);
              
              // Add density
              dens[idx] = Math.min(dens[idx] + 5, 10);
              
              // Add velocity
              const angle = Math.atan2(mouseY - height/2, mouseX - width/2) + Math.PI;
              u[idx] += Math.cos(angle) * 20;
              v[idx] += Math.sin(angle) * 20;
            }
          }
        }
      }
      
      // Update
      velStep(u, v, u_prev, v_prev, visc, dt);
      densStep(dens, dens_prev, u, v, diffusion, dt);
      
      // Decay
      for (let i = 0; i < size; i++) {
        dens[i] *= 0.995;
        u[i] *= 0.99;
        v[i] *= 0.99;
      }
      
      hue += 0.5;
    }
    
    function animate() {
      ctx.fillStyle = 'rgba(10, 10, 15, 0.15)';
      ctx.fillRect(0, 0, width, height);
      
      step(0.1);
      draw();
      requestAnimationFrame(animate);
    }
    
    // Events
    canvas.addEventListener('mousedown', e => { mouseDown = true; mouseX = e.clientX; mouseY = e.clientY; });
    canvas.addEventListener('mousemove', e => { mouseX = e.clientX; mouseY = e.clientY; });
    canvas.addEventListener('mouseup', () => mouseDown = false);
    canvas.addEventListener('mouseleave', () => mouseDown = false);
    canvas.addEventListener('wheel', e => {
      brushRadius = Math.max(10, Math.min(100, brushRadius - e.deltaY * 0.1));
      document.getElementById('radius').value = brushRadius;
    });
    
    // Controls
    document.getElementById('radius').oninput = e => brushRadius = parseInt(e.target.value);
    document.getElementById('diffusion').oninput = e => diffusion = parseInt(e.target.value) * 0.00001;
    
    const modes = ['smoke', 'ink', 'fire', 'rainbow'];
    const buttons = {
      'btn-smoke': 'smoke',
      'btn-ink': 'ink',
      'btn-fire': 'fire',
      'btn-rainbow': 'rainbow'
    };
    
    Object.entries(buttons).forEach(([id, mode]) => {
      document.getElementById(id).onclick = () => {
        colorMode = mode;
        Object.values(buttons).forEach(m => document.getElementById('btn-' + m).classList.remove('active'));
        document.getElementById(id).classList.add('active');
      };
    });
    document.getElementById('btn-smoke').classList.add('active');
    
    document.getElementById('btn-clear').onclick = () => {
      dens.fill(0);
      u.fill(0);
      v.fill(0);
    };
    
    window.addEventListener('resize', resize);
    resize();
    animate();
  </script>
</body>
</html>
