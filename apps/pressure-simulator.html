<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pressure Simulator — Shadow's Garden</title>
<meta name="description">Particle-based pressure and temperature simulator with chambers, pistons, and thermal dynamics.</meta>
<link rel="stylesheet" href="../style.css">
<script src="../nav.js" defer></script>
<style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #0a0a0f;
    min-height: 100vh;
    padding: 20px;
    box-sizing: border-box;
  }
  h1 {
    color: #e0e0e0;
    font-size: 1.8rem;
    margin-bottom: 5px;
    font-weight: 300;
  }
  .subtitle {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 20px;
  }
  canvas {
    border: 1px solid #333;
    border-radius: 4px;
    cursor: crosshair;
    box-shadow: 0 0 30px rgba(0,0,0,0.5);
  }
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 20px;
    justify-content: center;
    max-width: 800px;
  }
  .control-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
  }
  label {
    color: #888;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  input[type="range"] {
    width: 100px;
    accent-color: #666;
  }
  select, button {
    background: #1a1a20;
    color: #ccc;
    border: 1px solid #333;
    padding: 8px 14px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
  }
  button:hover {
    background: #252530;
    border-color: #555;
  }
  .stats {
    color: #555;
    font-size: 0.75rem;
    margin-top: 15px;
    font-family: monospace;
  }
  .info {
    color: #444;
    font-size: 0.7rem;
    margin-top: 10px;
    text-align: center;
    max-width: 600px;
  }
</style>
</head>
<body data-page-type="app">
  <h1>Pressure Simulator</h1>
  <div class="subtitle">Particle-based thermodynamics • Click to add particles • Drag to move walls</div>
  <canvas id="canvas"></canvas>
  
  <div class="controls">
    <div class="control-group">
      <label>Particles: <span id="countVal">150</span></label>
      <input type="range" id="particleCount" min="50" max="400" value="150" step="10">
    </div>
    <div class="control-group">
      <label>Temperature</label>
      <input type="range" id="temperature" min="0.1" max="5" value="1" step="0.1">
    </div>
    <div class="control-group">
      <label>Presets</label>
      <select id="preset">
        <option value="gas">Gas Chamber</option>
        <option value="piston">Piston Engine</option>
        <option value="diffusion">Diffusion</option>
        <option value="heat">Heat Transfer</option>
        <option value="vacuum">Vacuum Chamber</option>
      </select>
    </div>
    <div class="control-group">
      <label>Actions</label>
      <button id="resetBtn">Reset</button>
    </div>
  </div>
  
  <div class="stats" id="stats">Particles: 150 | Temperature: 1.0x | FPS: 0</div>
  <div class="info">Click to add particles • Drag walls to move them • Watch pressure build in confined spaces</div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    let width, height;
    let particles = [];
    let walls = [];
    let temperature = 1;
    let lastTime = performance.now();
    let frames = 0;
    let fps = 0;
    
    const presets = {
      gas: {
        walls: [
          {x: 100, y: 100, w: 400, h: 300}
        ],
        particles: 150
      },
      piston: {
        walls: [
          {x: 100, y: 100, w: 400, h: 50},
          {x: 100, y: 150, w: 30, h: 200},
          {x: 470, y: 150, w: 30, h: 200},
          {x: 100, y: 350, w: 400, h: 30},
          {x: 250, y: 280, w: 100, h: 20}
        ],
        particles: 200
      },
      diffusion: {
        walls: [
          {x: 50, y: 100, w: 200, h: 300},
          {x: 350, y: 100, w: 200, h: 300},
          {x: 250, y: 100, w: 100, h: 100, type: 'door', open: true}
        ],
        particles: 150
      },
      heat: {
        walls: [
          {x: 100, y: 80, w: 400, h: 340}
        ],
        particles: 120
      },
      vacuum: {
        walls: [
          {x: 150, y: 100, w: 300, h: 300}
        ],
        particles: 30
      }
    };

    function resize() {
      width = Math.min(600, window.innerWidth - 40);
      height = Math.min(500, window.innerHeight - 250);
      canvas.width = width;
      canvas.height = height;
    }

    function initParticles(count) {
      particles = [];
      const chamber = walls.find(w => !w.type) || {x: 100, y: 100, w: width - 200, h: height - 100};
      
      for (let i = 0; i < count; i++) {
        particles.push({
          x: chamber.x + Math.random() * chamber.w,
          y: chamber.y + Math.random() * chamber.h,
          vx: (Math.random() - 0.5) * 4,
          vy: (Math.random() - 0.5) * 4,
          color: `hsl(${Math.random() * 60 + 200}, 80%, 60%)`
        });
      }
    }

    function loadPreset(name) {
      const p = presets[name];
      walls = p.walls.map(w => ({...w, type: w.type || 'solid'}));
      initParticles(p.particles);
      document.getElementById('particleCount').value = p.particles;
      document.getElementById('countVal').textContent = p.particles;
    }

    function update() {
      const dt = 0.5;
      
      for (const p of particles) {
        p.vx *= 0.999;
        p.vy *= 0.999;
        
        p.vx += (Math.random() - 0.5) * temperature * 0.5;
        p.vy += (Math.random() - 0.5) * temperature * 0.5;
        
        p.x += p.vx * dt;
        p.y += p.vy * dt;
        
        for (const wall of walls) {
          if (wall.type === 'door' && wall.open) continue;
          
          if (p.x > wall.x && p.x < wall.x + wall.w &&
              p.y > wall.y && p.y < wall.y + wall.h) {
            
            const overlapLeft = p.x - wall.x;
            const overlapRight = (wall.x + wall.w) - p.x;
            const overlapTop = p.y - wall.y;
            const overlapBottom = (wall.y + wall.h) - p.y;
            
            const minOverlap = Math.min(overlapLeft, overlapRight, overlapTop, overlapBottom);
            
            if (minOverlap === overlapLeft) {
              p.x = wall.x - 2;
              p.vx *= -0.8;
            } else if (minOverlap === overlapRight) {
              p.x = wall.x + wall.w + 2;
              p.vx *= -0.8;
            } else if (minOverlap === overlapTop) {
              p.y = wall.y - 2;
              p.vy *= -0.8;
            } else {
              p.y = wall.y + wall.h + 2;
              p.vy *= -0.8;
            }
          }
        }
        
        if (p.x < 2) { p.x = 2; p.vx *= -0.8; }
        if (p.x > width - 2) { p.x = width - 2; p.vx *= -0.8; }
        if (p.y < 2) { p.y = 2; p.vy *= -0.8; }
        if (p.y > height - 2) { p.y = height - 2; p.vy *= -0.8; }
      }
    }

    function draw() {
      ctx.fillStyle = '#0a0a0f';
      ctx.fillRect(0, 0, width, height);
      
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 1;
      for (let x = 0; x < width; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
      }
      for (let y = 0; y < height; y += 50) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
      }
      
      for (const wall of walls) {
        if (wall.type === 'door') {
          ctx.strokeStyle = wall.open ? '#4a4' : '#a44';
          ctx.setLineDash([5, 5]);
        } else {
          ctx.strokeStyle = '#666';
          ctx.setLineDash([]);
        }
        ctx.lineWidth = 3;
        ctx.strokeRect(wall.x, wall.y, wall.w, wall.h);
        
        if (wall.type === 'solid') {
          ctx.fillStyle = 'rgba(50, 50, 60, 0.3)';
          ctx.fillRect(wall.x, wall.y, wall.w, wall.h);
        }
      }
      ctx.setLineDash([]);
      
      for (const p of particles) {
        const speed = Math.sqrt(p.vx * p.vx + p.vy * p.vy);
        const hue = 200 + speed * 20;
        const lightness = 50 + speed * 10;
        
        ctx.beginPath();
        ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
        ctx.fillStyle = `hsl(${hue}, 70%, ${lightness}%)`;
        ctx.fill();
      }
    }

    function animate() {
      update();
      draw();
      
      frames++;
      const now = performance.now();
      if (now - lastTime >= 1000) {
        fps = frames;
        frames = 0;
        lastTime = now;
        document.getElementById('stats').textContent = 
          `Particles: ${particles.length} | Temperature: ${temperature.toFixed(1)}x | FPS: ${fps}`;
      }
      
      requestAnimationFrame(animate);
    }

    document.getElementById('particleCount').addEventListener('input', (e) => {
      const count = parseInt(e.target.value);
      document.getElementById('countVal').textContent = count;
      initParticles(count);
    });

    document.getElementById('temperature').addEventListener('input', (e) => {
      temperature = parseFloat(e.target.value);
    });

    document.getElementById('preset').addEventListener('change', (e) => {
      loadPreset(e.target.value);
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      loadPreset(document.getElementById('preset').value);
    });

    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      for (let i = 0; i < 10; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 3 + 1;
        particles.push({
          x: x + (Math.random() - 0.5) * 20,
          y: y + (Math.random() - 0.5) * 20,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          color: `hsl(${Math.random() * 60 + 200}, 80%, 60%)`
        });
      }
      document.getElementById('countVal').textContent = particles.length;
    });

    let dragging = null;
    canvas.addEventListener('mousedown', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      for (let i = 0; i < walls.length; i++) {
        const w = walls[i];
        if (x > w.x - 10 && x < w.x + w.w + 10 && y > w.y - 10 && y < w.y + w.h + 10) {
          dragging = i;
          break;
        }
      }
    });

    canvas.addEventListener('mousemove', (e) => {
      if (dragging !== null) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const w = walls[dragging];
        w.x = Math.max(0, Math.min(width - w.w, x - w.w / 2));
        w.y = Math.max(0, Math.min(height - w.h, y - w.h / 2));
      }
    });

    canvas.addEventListener('mouseup', () => {
      dragging = null;
    });

    window.addEventListener('resize', resize);

    resize();
    loadPreset('gas');
    animate();
  </script>
</body>
</html>
