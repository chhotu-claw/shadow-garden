<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Double Pendulum Chaos — Shadow's Garden</title>
<meta name="description" content="Drag to set angles, watch chaotic trajectories unfold. RK4 integration for accurate physics.">
<link rel="stylesheet" href="../style.css">
<script src="../nav.js" defer></script>
<style>
  body { margin: 0; overflow: hidden; background: #0d0d12; }
  canvas { display: block; }
  .controls {
    position: fixed;
    bottom: 20px;
    left: 20px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    z-index: 10;
  }
  button, input, label {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    color: #ccc;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
    font-size: 12px;
  }
  button:hover { background: rgba(255,255,255,0.15); }
  input[type="range"] { padding: 0; width: 80px; }
  label { padding: 8px; cursor: default; }
  .info {
    position: fixed;
    top: 20px;
    left: 20px;
    color: rgba(255,255,255,0.4);
    font-size: 12px;
    font-family: monospace;
  }
  .presets { display: flex; gap: 8px; margin-bottom: 8px; }
</style>
</head>
<body data-page-type="app">
  <canvas id="canvas"></canvas>
  <div class="info">Drag the pendulums to set angles • Space to pause • R to reset</div>
  <div class="controls">
    <div class="presets">
      <button id="p1">Classic</button>
      <button id="p2">Chaos Start</button>
      <button id="p3">High Energy</button>
      <button id="p4">Inverted</button>
    </div>
    <label>Mass 1: <input type="range" id="m1" min="1" max="20" value="10"></label>
    <label>Mass 2: <input type="range" id="m2" min="1" max="20" value="10"></label>
    <label>Length 1: <input type="range" id="l1" min="50" max="200" value="150"></label>
    <label>Length 2: <input type="range" id="l2" min="50" max="200" value="150"></label>
    <label>Gravity: <input type="range" id="g" min="1" max="30" value="9"></label>
    <button id="trace">Trace: ON</button>
    <button id="clear">Clear Trail</button>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    let width, height;
    let paused = false;
    let showTrace = true;
    
    let theta1 = Math.PI / 2;
    let theta2 = Math.PI / 2;
    let omega1 = 0;
    let omega2 = 0;
    
    let m1 = 10, m2 = 10, l1 = 150, l2 = 150, g = 9;
    let trail = [];
    const MAX_TRAIL = 800;
    
    function resize() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
    }
    
    // Runge-Kutta 4th order integration
    function computeDerivatives(t1, t2, w1, w2) {
      const delta = t1 - t2;
      const sinD = Math.sin(delta);
      const cosD = Math.cos(delta);
      const den1 = (m1 + m2) * l1 - m2 * l1 * cosD * cosD;
      const den2 = (l2 / l1) * den1;
      
      const alpha1 = (m2 * l1 * w1 * w1 * sinD * cosD + 
                      m2 * g * Math.sin(t2) * cosD + 
                      m2 * l2 * w2 * w2 * sinD - 
                      (m1 + m2) * g * Math.sin(t1)) / den1;
                      
      const alpha2 = (-m2 * l2 * w2 * w2 * sinD * cosD + 
                      (m1 + m2) * g * Math.sin(t1) * cosD - 
                      (m1 + m2) * l1 * w1 * w1 * sinD - 
                      (m1 + m2) * g * Math.sin(t2)) / den2;
      
      return { dw1: alpha1, dw2: alpha2, dt1: w1, dt2: w2 };
    }
    
    function rk4Step(dt) {
      const k1 = computeDerivatives(theta1, theta2, omega1, omega2);
      
      const k2 = computeDerivatives(
        theta1 + k1.dt1 * dt/2, theta2 + k1.dt2 * dt/2,
        omega1 + k1.dw1 * dt/2, omega2 + k1.dw2 * dt/2
      );
      
      const k3 = computeDerivatives(
        theta1 + k2.dt1 * dt/2, theta2 + k2.dt2 * dt/2,
        omega1 + k2.dw1 * dt/2, omega2 + k2.dw2 * dt/2
      );
      
      const k4 = computeDerivatives(
        theta1 + k3.dt1 * dt, theta2 + k3.dt2 * dt,
        omega1 + k3.dw1 * dt, omega2 + k3.dw2 * dt
      );
      
      theta1 += (k1.dt1 + 2*k2.dt1 + 2*k3.dt1 + k4.dt1) * dt / 6;
      theta2 += (k1.dt2 + 2*k2.dt2 + 2*k3.dt2 + k4.dt2) * dt / 6;
      omega1 += (k1.dw1 + 2*k2.dw1 + 2*k3.dw1 + k4.dw1) * dt / 6;
      omega2 += (k1.dw2 + 2*k2.dw2 + 2*k3.dw2 + k4.dw2) * dt / 6;
    }
    
    function getPositions() {
      const cx = width / 2;
      const cy = height / 3;
      const x1 = cx + l1 * Math.sin(theta1);
      const y1 = cy + l1 * Math.cos(theta1);
      const x2 = x1 + l2 * Math.sin(theta2);
      const y2 = y1 + l2 * Math.cos(theta2);
      return { cx, cy, x1, y1, x2, y2 };
    }
    
    function update() {
      if (paused) return;
      
      // Multiple sub-steps for stability
      for (let i = 0; i < 4; i++) {
        rk4Step(0.02);
      }
      
      const pos = getPositions();
      if (showTrace) {
        trail.push({ x: pos.x2, y: pos.y2 });
        if (trail.length > MAX_TRAIL) trail.shift();
      }
    }
    
    function draw() {
      ctx.fillStyle = 'rgba(13, 13, 18, 0.15)';
      ctx.fillRect(0, 0, width, height);
      
      const pos = getPositions();
      
      // Draw trail
      if (showTrace && trail.length > 1) {
        for (let i = 1; i < trail.length; i++) {
          const alpha = i / trail.length;
          const hue = (i * 0.5 + Date.now() * 0.01) % 360;
          ctx.strokeStyle = `hsla(${hue}, 80%, 60%, ${alpha})`;
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(trail[i-1].x, trail[i-1].y);
          ctx.lineTo(trail[i].x, trail[i].y);
          ctx.stroke();
        }
      }
      
      // Draw rods
      ctx.strokeStyle = 'rgba(255,255,255,0.4)';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(pos.cx, pos.cy);
      ctx.lineTo(pos.x1, pos.y1);
      ctx.lineTo(pos.x2, pos.y2);
      ctx.stroke();
      
      // Draw pivot
      ctx.fillStyle = '#fff';
      ctx.beginPath();
      ctx.arc(pos.cx, pos.cy, 5, 0, Math.PI * 2);
      ctx.fill();
      
      // Draw masses
      const grad1 = ctx.createRadialGradient(pos.x1, pos.y1, 0, pos.x1, pos.y1, m1 * 2);
      grad1.addColorStop(0, '#ff6b6b');
      grad1.addColorStop(1, '#c92a2a');
      ctx.fillStyle = grad1;
      ctx.beginPath();
      ctx.arc(pos.x1, pos.y1, m1 * 2, 0, Math.PI * 2);
      ctx.fill();
      
      const grad2 = ctx.createRadialGradient(pos.x2, pos.y2, 0, pos.x2, pos.y2, m2 * 2);
      grad2.addColorStop(0, '#4ecdc4');
      grad2.addColorStop(1, '#087f5b');
      ctx.fillStyle = grad2;
      ctx.beginPath();
      ctx.arc(pos.x2, pos.y2, m2 * 2, 0, Math.PI * 2);
      ctx.fill();
    }
    
    function animate() {
      update();
      draw();
      requestAnimationFrame(animate);
    }
    
    // Mouse drag
    let dragging = null;
    canvas.addEventListener('mousedown', (e) => {
      const pos = getPositions();
      const d1 = Math.hypot(e.clientX - pos.x1, e.clientY - pos.y1);
      const d2 = Math.hypot(e.clientX - pos.x2, e.clientY - pos.y2);
      
      if (d2 < m2 * 3 + 20) {
        dragging = 2;
      } else if (d1 < m1 * 3 + 20) {
        dragging = 1;
      }
    });
    
    canvas.addEventListener('mousemove', (e) => {
      const cx = width / 2;
      const cy = height / 3;
      
      if (dragging === 1) {
        theta1 = Math.atan2(e.clientX - cx, e.clientY - cy);
        omega1 = 0;
        omega2 = 0;
        trail = [];
      } else if (dragging === 2) {
        theta2 = Math.atan2(e.clientX - pos.x1, e.clientY - pos.y1);
        omega1 = 0;
        omega2 = 0;
        trail = [];
      }
    });
    
    canvas.addEventListener('mouseup', () => { dragging = null; });
    canvas.addEventListener('mouseleave', () => { dragging = null; });
    
    // Keyboard
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') { paused = !paused; e.preventDefault(); }
      if (e.code === 'KeyR') { trail = []; omega1 = 0; omega2 = 0; }
    });
    
    // Controls
    document.getElementById('m1').oninput = (e) => { m1 = +e.target.value; trail = []; };
    document.getElementById('m2').oninput = (e) => { m2 = +e.target.value; trail = []; };
    document.getElementById('l1').oninput = (e) => { l1 = +e.target.value; trail = []; };
    document.getElementById('l2').oninput = (e) => { l2 = +e.target.value; trail = []; };
    document.getElementById('g').oninput = (e) => { g = +e.target.value; };
    
    document.getElementById('trace').onclick = (e) => {
      showTrace = !showTrace;
      e.target.innerText = 'Trace: ' + (showTrace ? 'ON' : 'OFF');
    };
    document.getElementById('clear').onclick = () => { trail = []; };
    
    // Presets
    document.getElementById('p1').onclick = () => {
      theta1 = Math.PI / 2; theta2 = Math.PI / 2;
      omega1 = 0; omega2 = 0;
      trail = [];
    };
    document.getElementById('p2').onclick = () => {
      theta1 = Math.PI / 2; theta2 = Math.PI / 2 + 0.01;
      omega1 = 0; omega2 = 0;
      trail = [];
    };
    document.getElementById('p3').onclick = () => {
      theta1 = 0; theta2 = 0;
      omega1 = 5; omega2 = 5;
      trail = [];
    };
    document.getElementById('p4').onclick = () => {
      theta1 = Math.PI; theta2 = Math.PI;
      omega1 = 0; omega2 = 0;
      trail = [];
    };
    
    window.addEventListener('resize', resize);
    resize();
    animate();
  </script>
</body>
</html>
